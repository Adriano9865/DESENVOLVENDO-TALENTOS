<div class="animate-fade-in-up bg-white p-8 rounded-2xl shadow-lg">

  <!-- Header -->
  <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-4 mb-8 pb-6 border-b border-slate-200">
    <div>
      <h2 class="text-2xl font-bold text-slate-800">Notas do Curso</h2>
      <p class="text-slate-500 mt-1">Acompanhe o desempenho dos alunos e lance notas manuais.</p>
    </div>
    <div class="flex items-center gap-4 shrink-0">
      <select (change)="updateFilter($event)" class="w-full sm:w-auto block pl-3 pr-10 py-2 text-base bg-slate-100 border border-slate-300 text-slate-900 rounded-lg focus:bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent sm:text-sm">
        <option value="all">Todos os Alunos</option>
        @for(studentInfo of studentGrades(); track studentInfo.student.id) {
          <option [value]="studentInfo.student.id">{{ studentInfo.student.fullName }}</option>
        }
      </select>
      <button (click)="openAddManualGradeModal()" class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all transform hover:-translate-y-0.5 active:scale-95 whitespace-nowrap">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
        <span>Lançar Nota</span>
      </button>
    </div>
  </div>

  <!-- Grades View -->
  @if (enrolledStudents().length > 0) {
    @if (filteredStudentGrades().length > 0) {
      <div class="space-y-8">
        @for (studentInfo of filteredStudentGrades(); track studentInfo.student.id) {
          <div class="p-6 border border-slate-200 rounded-lg bg-slate-50 shadow-sm">
            <!-- Student Header -->
            <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-3 mb-4">
              <h3 class="text-xl font-semibold text-slate-800">{{ studentInfo.student.fullName }}</h3>
              @if (studentInfo.averageGrade !== null) {
                <div class="text-center sm:text-right bg-indigo-50 p-3 rounded-lg">
                  <p class="text-xs font-medium text-indigo-700">MÉDIA GERAL</p>
                  <p class="text-2xl font-bold text-indigo-600">{{ studentInfo.averageGrade }}%</p>
                </div>
              }
            </div>

            <!-- Grades Table -->
            @if (studentInfo.grades.length > 0) {
              <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                  <thead class="text-xs text-slate-600 uppercase border-b border-slate-200">
                    <tr>
                      <th scope="col" class="px-4 py-3 font-medium">Avaliação</th>
                      <th scope="col" class="px-4 py-3 font-medium">Tipo</th>
                      <th scope="col" class="px-4 py-3 font-medium text-center">Nota</th>
                      <th scope="col" class="px-4 py-3 font-medium text-right">Ações</th>
                    </tr>
                  </thead>
                  <tbody class="text-slate-700">
                    @for (gradeItem of studentInfo.grades; track gradeItem.type + (gradeItem.type === 'quiz' ? gradeItem.data.quizId : gradeItem.data.id)) {
                      @if (gradeItem.type === 'manual') {
                        <tr class="group hover:bg-white/70 transition-colors duration-200 cursor-pointer" (click)="openEditManualGradeModal(gradeItem.data)">
                          <td class="px-4 py-4 font-semibold text-slate-800">{{ gradeItem.data.title }}</td>
                          <td class="px-4 py-4">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                              Nota Manual
                            </span>
                          </td>
                          <td class="px-4 py-4 text-center font-bold text-lg text-slate-800">{{ gradeItem.data.score }}%</td>
                          <td class="px-4 py-4 text-right">
                            <button (click)="$event.stopPropagation(); deleteManualGrade(gradeItem.data.id)" class="p-2 text-slate-400 rounded-full opacity-0 group-hover:opacity-100 hover:bg-red-100 hover:text-red-600 transition-all" title="Excluir Nota">
                              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                              </svg>
                            </button>
                          </td>
                        </tr>
                      } @else {
                        <tr class="bg-white">
                          <td class="px-4 py-4 font-semibold text-slate-800">{{ gradeItem.data.quizTitle }}</td>
                          <td class="px-4 py-4">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                              Prova Automática
                            </span>
                          </td>
                          <td class="px-4 py-4 text-center font-bold text-lg text-slate-800">{{ gradeItem.data.score }}%</td>
                          <td class="px-4 py-4 text-right"></td>
                        </tr>
                      }
                    }
                  </tbody>
                </table>
              </div>
            } @else {
              <div class="text-center py-8 px-4">
                <p class="text-sm text-slate-500">Nenhuma nota registrada para este aluno.</p>
              </div>
            }
          </div>
        }
      </div>
    } @else {
       <div class="text-center py-16 px-6">
        <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
           <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
        </svg>
        <h3 class="mt-2 text-xl font-semibold text-slate-900">Nenhum aluno encontrado</h3>
        <p class="mt-1 text-sm text-slate-500">O aluno que você está procurando não foi encontrado neste curso.</p>
      </div>
    }
  } @else {
     <div class="text-center py-16 px-6">
       <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
         <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.653-.125-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.653.125-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
       </svg>
      <h3 class="mt-2 text-xl font-semibold text-slate-900">Nenhum aluno no curso</h3>
      <p class="mt-1 text-sm text-slate-500">Matricule alunos no curso para poder gerenciar as notas.</p>
    </div>
  }

</div>

<!-- Modal -->
@if (isManualGradeModalOpen()) {
  <app-manual-grade-modal
    [students]="enrolledStudents()"
    [courseId]="course().id"
    [grade]="manualGradeToEdit()"
    (close)="isManualGradeModalOpen.set(false)"
    (save)="saveManualGrade($event)"
  />
}
